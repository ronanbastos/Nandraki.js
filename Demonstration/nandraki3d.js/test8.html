<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Draki Engine - Física 3D Completa</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <style> body { margin: 0; overflow: hidden; } canvas { display: block; } </style>
</head>
<body>
    <script src="draki3d.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    
    <script>
   
    const draki = new ThreeCore();
    draki.init(document.body);
    animax.start();
    
    Animax.prototype._update = function() {
        requestAnimationFrame(() => this._update());
        const deltaTime = this.clock.getDelta();
        for (const mixer of this.mixers.values()) { mixer.update(deltaTime); }
        draki.renderer.render(draki.scene, draki.camera);
    }

    // ==========================================================
    // CENÁRIO
    // ==========================================================
    let luz = Game.create("light", "Sol");
    luz.position.set(5, 10, 5);
    draki.scene.add(luz);

    let camera = Game.create("camera", "MainCam");
    camera.position.set(0, 5, 10);
    draki.scene.add(camera);
    draki.camera = camera;
    draki.scene.background = new THREE.Color(0x77aaff);

    const ground = new THREE.Mesh(
        new THREE.PlaneGeometry(100, 100),
        new THREE.MeshPhongMaterial({ color: 0x999999, depthWrite: false })
    );
    ground.rotation.x = -Math.PI / 2;
    draki.scene.add(ground);

    // --- PAREDE NO CHÃO ---
    let parede = Game.create("cube", "P");
    parede.position.set(2, 1, 2);
    parede.scale.set(2, 2, 2);
    parede.material.color.set(0xff0000);
    draki.scene.add(parede);
    drak("P").addTag("solido");

    // --- PLATAFORMA FLUTUANTE (NOVIDADE!) ---
    let plat = Game.create("cube", "Plataforma");
    plat.position.set(-2, 1.5, 0); // Está no ar!
    plat.scale.set(3, 0.5, 3);     // Larga e fina
    plat.material.color.set(0x0000ff);
    draki.scene.add(plat);
    drak("Plataforma").addTag("solido"); // Importante: tem a tag solido

    // --- PLAYER ---
    let player = null;
    const loader = new THREE.GLTFLoader();
    loader.load('https://threejs.org/examples/models/gltf/Soldier.glb', (gltf) => {
        player = gltf.scene;
        player.name = "Player";
        draki.scene.add(player);
        animax.add(player, gltf.animations);
        animax.play("Player", "Idle");
    });

    // ==========================================================
    // CONTROLES
    // ==========================================================
    let velocity = { x: 0, y: 0, z: 0 };
    let speed = 0.02;
    let friction = 0.90;
    let isMoving = false;
    let keys = { left: false, right: false, forward: false, back: false, space: false };

    document.addEventListener("keydown", (e) => {
      if (e.key === "ArrowLeft" || e.key === "a") keys.left = true;
      if (e.key === "ArrowRight" || e.key === "d") keys.right = true;
      if (e.key === "ArrowUp" || e.key === "w") keys.forward = true;
      if (e.key === "ArrowDown" || e.key === "s") keys.back = true;
      if (e.key === " " || e.code === "Space") keys.space = true;
    });
    document.addEventListener("keyup", (e) => {
      if (e.key === "ArrowLeft" || e.key === "a") keys.left = false;
      if (e.key === "ArrowRight" || e.key === "d") keys.right = false;
      if (e.key === "ArrowUp" || e.key === "w") keys.forward = false;
      if (e.key === "ArrowDown" || e.key === "s") keys.back = false;
      if (e.key === " " || e.code === "Space") keys.space = false;
    });

    function updateMovement() {
      if (player) {
          // 1. INPUTS
          if (keys.left) velocity.x -= speed;
          if (keys.right) velocity.x += speed;
          if (keys.forward) velocity.z -= speed;
          if (keys.back) velocity.z += speed;

          velocity.x *= friction;
          velocity.z *= friction;
          if (Math.abs(velocity.x) < 0.001) velocity.x = 0;
          if (Math.abs(velocity.z) < 0.001) velocity.z = 0;

          // 2. GRAVIDADE (Gravix agora checa Y)
          gravix.update("Player", keys.space, 0.40);

          // 3. COLISÃO HORIZONTAL (Physix)
          let moveX = velocity.x;
          let moveZ = velocity.z;

          // Note que passamos 0 no Y, pois o Gravix já cuidou do Y.
          // Aqui só queremos saber se bate nas laterais.
          if (moveX !== 0 && physix.check("Player", moveX, 0, 0, "solido")) moveX = 0;
          if (moveZ !== 0 && physix.check("Player", 0, 0, moveZ, "solido")) moveZ = 0;

          // 4. APLICA MOVIMENTO
          player.position.x += moveX;
          player.position.z += moveZ;

          // 5. ANIMAÇÃO
          const totalSpeed = Math.sqrt(velocity.x**2 + velocity.z**2);

          if (gravix.isGrounded) {
              if (totalSpeed > 0.01) {
                  if (!isMoving) {
                      animax.play("Player", "Walk");
                      isMoving = true;
                  }
                  player.rotation.y = Math.atan2(-velocity.x, -velocity.z);
              } else if (isMoving) {
                  animax.play("Player", "Idle");
                  isMoving = false;
              }
          } else {
              // Se tiver animação de pulo, pode colocar aqui
              // animax.play("Player", "Jump"); 
          }

          // 6. CÂMERA
          camera.position.x += (player.position.x - camera.position.x) * 0.1;
          camera.position.z += ((player.position.z + 6) - camera.position.z) * 0.1;
          camera.position.y += ((player.position.y + 4) - camera.position.y) * 0.1;
          camera.lookAt(player.position.x, player.position.y + 1, player.position.z);
          
          hud.update("X", player.position.x.toFixed(1));
          hud.update("Y", player.position.y.toFixed(1));
          hud.update("Z", player.position.z.toFixed(1));
          hud.draw();
      }
      requestAnimationFrame(updateMovement);
    }
    
    const hud = new HUD();
    hud.add("X", 0, 10, 30, "#00ff00");
    hud.add("Y", 0, 10, 50, "#00ff00");
    hud.add("Z", 0, 10, 70, "#00ff00");
    
    updateMovement();
    </script>
</body>
</html>
